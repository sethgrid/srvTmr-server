<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Reverse Geocoding</title>
    <style>
      html, body {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
      #map-canvas{
        width=100px;
        height=100px;
      }
      #panel {
        position: absolute;
        top: 5px;
        left: 50%;
        margin-left: -180px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
      }
      #latlng {
        width: 225px;
      }
      href {
        padding: 10px;
        color: green;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places"></script>
    <script>
console.log("starting");
var geocoder;
var map;
var infowindow = new google.maps.InfoWindow();
var marker;
var lat;
var long;

function initGeolocation() {
    console.log("initGeo");
    if (navigator && navigator.geolocation) {
        console.log("going to do stuff");
        navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
    } else {
        console.log('Geolocation is not supported');
    }
}

function successCallback(position) {
    console.log("successCallback");
    lat = position.coords.latitude;
    long = position.coords.longitude;
    console.log(lat, long);
    geocoder = new google.maps.Geocoder();
    //var latlng = new google.maps.LatLng(40.730885,-73.997383);
    var latlng = new google.maps.LatLng(lat, long);
    var mapOptions = {
        zoom: 17,
        center: latlng,
        mapTypeId: 'roadmap'
    }
    map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

    geocoder.geocode({
        'latLng': latlng
    }, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
            if (results[1]) {
                console.log(results[0].formatted_address);
                infowindow.setContent(results[1].formatted_address);

            } else {
                alert('No results found');
            }
        } else {
            alert('Geocoder failed due to: ' + status);
        }
    });

     var request = {
      location: latlng,
      radius: 500,
      types: ['food']
     };
     var service = new google.maps.places.PlacesService(map);
     service.nearbySearch(request, callback);
}

function callback(results, status) {
  if (status == google.maps.places.PlacesServiceStatus.OK) {
    console.log(results);
    status = document.getElementById("status")
    status.innerHTML = "";
    var select = document.getElementById("select-box");

    for (var i = 0; i < results.length; i++) {
      // each of these is a result that we want. Add them to a dropdown.
      r = results[i];
      var option = document.createElement("option");
      option.text = r.name;
      option.value = r.place_id;
      select.appendChild(option);
      console.log(r.place_id + ", " + r.name + ", " + r.formatted_address + ", " + r.vicinity)
    }
  } else {
    console.log("status:", status)
    status = document.getElementById("status")
    status.innerHTML = "No food establishments found nearby."
  }
}

function errorCallback(position) {
    console.log("errBack called")
}

function initialize() {
    initGeolocation();

}

google.maps.event.addDomListener(window, 'load', initialize);
    </script>

  </head>
  <body>
    <div id="panel">
      <form action="upload.go" id="formy">
        <span id="status">Getting nearby establishments...</span>
        <select id="select-box" name="placeid"></select>
        <div class="stopwatch"></div>
        <input type="button" value="Submit Time" onclick="document.getElementById('formy').submit();">
      </form>
    </div>
    <div id="map-canvas"></div>
  </body>

<script>
var Stopwatch = function(elem, options) {

  var timer       = createTimer(),
      startButton = createButton("start", start),
      stopButton  = createButton("stop", stop),
      resetButton = createButton("reset", reset),
      offset,
      clock,
      interval;

  // default options
  options = options || {};
  options.delay = options.delay || 1;

  // append elements
  elem.appendChild(timer);
  elem.appendChild(document.createElement("br"));
  elem.appendChild(startButton);
  elem.appendChild(stopButton);
  elem.appendChild(resetButton);

  // initialize
  reset();

  // private functions
  function createTimer() {
    //return document.createElement("span")
    a = document.createElement("input");
    a.type = "text";
    a.name = "time";
    a.value = "0";
    return a
  }

  function createButton(action, handler) {
    var a = document.createElement("input");
    a.type = "button"
    a.value = action;

    a.addEventListener("click", function(event) {
      handler();
      event.preventDefault();
    });
    return a;
  }

  function start() {
    if (!interval) {
      offset   = Date.now();
      interval = setInterval(update, options.delay);
    }
  }

  function stop() {
    if (interval) {
      clearInterval(interval);
      interval = null;
    }
  }

  function reset() {
    clock = 0;
    render();
  }

  function update() {
    clock += delta();
    render();
  }

  function render() {
    timer.value = clock/1000;
  }

  function delta() {
    var now = Date.now(),
        d   = now - offset;

    offset = now;
    return d;
  }

  // public API
  this.start  = start;
  this.stop   = stop;
  this.reset  = reset;
};

var elems = document.getElementsByClassName("stopwatch");

for (var i=0, len=elems.length; i<len; i++) {
  new Stopwatch(elems[i]);
}
</script>


</html>